#!/bin/bash

SRC=${1:-$HOME/src}
START=`pwd`

# update SRC to be an absolute path
cd $SRC
SRC=`pwd`

color()(set -o pipefail;"$@" 2>&1>&3|sed $'s,.*,\e[31m&\e[m,'>&2)3>&1

function git_pull {
	cd $1
	echo $1 î‚ $(git symbolic-ref --short -q HEAD)
	color git fetch --all -Ppqtf
	color git pull -q
}

# ctrl-c exits the entire script
trap "echo; exit" INT

# make sure security key is unlocked
ssh -Nf git@github.com

gitdirs=$(find $SRC -name .git -type d 2>/dev/null | sed 's#/.git$##g' | sort)
for f in $gitdirs; do
	git_pull $f
done

cd $START
